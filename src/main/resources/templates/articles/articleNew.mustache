<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>새 게시글 작성</title>
    <!-- Bootstrap CSS 추가 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Kakao 지도 SDK -->
    <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=7ae6f570f45c759f820a16cbc11adcb2&libraries=services"></script>
    <style>
        .main-container {
            max-width: 800px; /* 원하는 최대 너비 설정 */
            margin: 0 auto; /* 가운데 정렬 */
        }
    </style>
</head>
<body>
{{>layouts/header}}

<div class="container main-container mt-4">
    <h2 class="mb-4">새 게시글 작성</h2>
    <form action="/articles/upload" method="post" enctype="multipart/form-data">
        <!-- 이미지 업로드 -->
        <div class="mb-3">
            <label for="fileInput" class="form-label">이미지 업로드</label>
            <input type="file" id="fileInput" name="file" accept="image/*" class="form-control">
        </div>
        <!-- 이미지 미리보기 -->
        <div class="mb-3" id="preview" style="display: flex; flex-wrap: wrap;"></div>
        <!-- 내용 입력 -->
        <div class="mb-3">
            <label for="content" class="form-label">내용</label>
            <textarea class="form-control" id="content" placeholder="내용을 입력하세요" name="content" rows="4"></textarea>
        </div>
        <!-- 장소 검색 -->
        <div class="mb-3">
            <label for="keyword" class="form-label">장소 검색</label>
            <div class="input-group">
                <input type="text" id="keyword" placeholder="장소를 입력하세요" class="form-control">
                <button type="button" id="searchButton" class="btn btn-primary">검색</button>
            </div>
        </div>
        <!-- 지도 및 장소 정보 -->
        <div id="placeInfo" class="mb-3"></div>
        <div id="map" class="mb-3" style="width: 100%; height: 300px;"></div>
        <input type="hidden" id="location" name="location">
        <!-- 버튼 그룹 -->
        <div class="d-flex justify-content-between">
            <a href="/main" class="btn btn-secondary">목록 페이지</a>
            <button type="submit" class="btn btn-success">업로드</button>
        </div>
    </form>
</div>

{{>layouts/footer}}
<!-- Bootstrap JS 추가 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // 이미지 미리보기 스크립트
    document.getElementById('fileInput').addEventListener('change', function(event) {
        const files = event.target.files;
        const previewContainer = document.getElementById('preview');
        previewContainer.innerHTML = "";

        Array.from(files).forEach(file => {
            const reader = new FileReader();

            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.classList.add('img-thumbnail', 'me-2', 'mb-2');
                img.style.width = '200px';
                img.style.height = '200px';
                previewContainer.appendChild(img);
            };

            reader.readAsDataURL(file);
        });
    });

    // Kakao 지도 및 장소 검색
    const mapContainer = document.getElementById('map');
    const mapOption = {
        center: new kakao.maps.LatLng(37.5665, 126.9780),
        level: 3
    };

    const map = new kakao.maps.Map(mapContainer, mapOption);
    const ps = new kakao.maps.services.Places();
    const marker = new kakao.maps.Marker({ map: map });

    document.getElementById('searchButton').addEventListener('click', function() {
        const keyword = document.getElementById('keyword').value;
        const locationInput = document.getElementById('location');
        if (!keyword.trim()) {
            locationInput.value = null;
            alert('검색어를 입력하세요.');
            return;
        }
        ps.keywordSearch(keyword, function(data, status) {
            if (status === kakao.maps.services.Status.OK) {
                displayMarker(data[0]);
            } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
                alert('검색 결과가 없습니다.');
                locationInput.value = null;
            } else {
                alert('검색 중 오류가 발생했습니다.');
                locationInput.value = null;
            }
        });
    });

    function displayMarker(place) {
        const coords = new kakao.maps.LatLng(place.y, place.x);
        marker.setPosition(coords);
        map.setCenter(coords);

        const locationString = `${place.place_name}|${place.x}|${place.y}`;
        document.getElementById('location').value = locationString;

        const infowindow = new kakao.maps.InfoWindow({
            content: `<div style="padding:5px;">${place.place_name}</div>`
        });
        infowindow.open(map, marker);

        // 장소 정보 표시
        const placeInfo = document.getElementById('placeInfo');
        placeInfo.innerHTML = `
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">${place.place_name}</h5>
                    <p class="card-text">${place.address_name}</p>
                </div>
            </div>
        `;
    }
</script>
</body>
</html>